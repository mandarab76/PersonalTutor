<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Omkar Tutor</title>
    <style>
        /* Mobile-First CSS */
        body { font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif; margin: 0; padding: 20px; background-color: #f0f2f5; text-align: center; }
        
        .card {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.1s;
            cursor: pointer;
        }
        .card:active { transform: scale(0.98); }
        
        /* Mrunal's Button (Pink) */
        #mrunal-btn { background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%); border: 4px solid #fff; }
        
        /* Gargi's Button (Blue) */
        #gargi-btn { background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); border: 4px solid #fff; }

        h1 { font-size: 24px; color: #333; margin-bottom: 30px; }
        h2 { margin: 0; font-size: 28px; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        p { color: white; margin: 5px 0 0 0; font-weight: bold; opacity: 0.9; }
        
        /* Icon Images */
        .icon { width: 80px; height: 80px; margin-bottom: 10px; display: block; margin-left: auto; margin-right: auto; }

        /* Microphone Pulse Animation */
        .listening { animation: pulse 1.5s infinite; border-color: red !important; }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(255, 0, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
        }

        #response-area { margin-top: 20px; padding: 15px; background: #fff; border-radius: 15px; min-height: 100px; text-align: left; display: none; border: 2px solid #ddd; }
        .hidden { display: none; }
        
        #api-key-input { width: 80%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 10px; }
        #status { color: #666; margin-top: 20px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="settings-area">
        <input type="password" id="api-key-input" placeholder="Paste OpenAI API Key here">
        <br>
        <button onclick="saveKey()" style="padding: 10px 20px; border-radius: 10px; background: #333; color: white; border: none; margin-bottom: 20px;">Save Key</button>
    </div>

    <h1>Who is studying? üè´</h1>

    <div class="card" id="mrunal-btn" onclick="activateAgent('Mrunal')">
        <img src="https://cdn-icons-png.flaticon.com/512/616/616430.png" class="icon" alt="Kitten">
        <h2>Mrunal</h2>
        <p>Class 4 ‚Ä¢ Magic Mode</p>
    </div>

    <div class="card" id="gargi-btn" onclick="activateAgent('Gargi')">
        <img src="https://cdn-icons-png.flaticon.com/512/867/867908.png" class="icon" alt="Wand">
        <h2>Gargi</h2>
        <p>Class 8 ‚Ä¢ Exam Mode</p>
    </div>

    <div id="status">Ready to help!</div>
    <div id="response-area"></div>

    <script>
        // --- 1. THE BRAIN (Syllabus Data) ---
        const MRUNAL_SYLLABUS = {
            "turkish": "The Turkish Cap (Cycle Test 1)",
            "cap": "The Turkish Cap (Cycle Test 1)",
            "andaman": "Adventure in the Andamans",
            "muttaji": "How old is Muttaji",
            "mars": "A Holiday on Mars",
            "treasure": "The Treasure Hunt",
            "bhabhut": "Sikke ka Bhabhut (Hindi)",
            "ujiyara": "Naya Ujiyara (Hindi Poem)"
        };

        let currentStudent = "";
        let apiKey = localStorage.getItem("openai_key");

        // Hide settings if key exists
        if(apiKey) {
            document.getElementById('settings-area').style.display = 'none';
        }

        function saveKey() {
            const input = document.getElementById('api-key-input').value.trim();
            if(input) {
                localStorage.setItem("openai_key", input);
                apiKey = input;
                document.getElementById('settings-area').style.display = 'none';
                alert("Key saved! You can now start.");
            } else {
                alert("Please paste a key first.");
            }
        }

        // --- 2. VOICE RECOGNITION ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.lang = 'en-IN'; // Indian English
        recognition.continuous = false;

        recognition.onstart = () => {
            document.getElementById('status').innerText = "I'm listening... üéôÔ∏è";
            document.getElementById('status').style.color = "red";
            if(currentStudent === 'Mrunal') document.getElementById('mrunal-btn').classList.add('listening');
            else document.getElementById('gargi-btn').classList.add('listening');
        };

        recognition.onend = () => {
            // Only reset status if we haven't started processing
            document.querySelectorAll('.card').forEach(c => c.classList.remove('listening'));
        };

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            document.getElementById('status').innerText = `Thinking about: "${transcript}"...`;
            document.getElementById('status').style.color = "#333";
            processQuery(transcript);
        };

        function activateAgent(student) {
            if(!apiKey) { 
                alert("Please enter API Key at the top first!"); 
                document.getElementById('settings-area').style.display = 'block';
                return; 
            }
            currentStudent = student;
            // Short, non-network introduction
            speak(`Hi ${student}. Speak now.`); 
            // Slight delay to ensure 'speak' doesn't conflict with 'listen'
            setTimeout(() => recognition.start(), 1000);
        }

        // --- 3. AI LOGIC (UPDATED WITH ERROR HANDLING) ---
        async function processQuery(text) {
            let systemPrompt = "";
            
            if (currentStudent === "Mrunal") {
                let context = "General Search";
                for (let key in MRUNAL_SYLLABUS) {
                    if (text.toLowerCase().includes(key)) context = "Syllabus Match: " + MRUNAL_SYLLABUS[key];
                }
                systemPrompt = `You are a playful AI for a 4th grader named Mrunal. 
                User said: "${text}". 
                Context: ${context}.
                Instructions: Keep it short (2 sentences). Be enthusiastic. Use emojis.`;
            } else {
                systemPrompt = `You are a strict tutor for an 8th grader named Gargi.
                User said: "${text}".
                Instructions: Give a direct, exam-focused definition or formula. No fluff. Bullet points.`;
            }

            try {
                // Call OpenAI
                const response = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "gpt-4o",
                        messages: [{role: "system", content: systemPrompt}, {role: "user", content: text}],
                        max_tokens: 150
                    })
                });

                // --- NEW: Check if API Key or Network failed ---
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || "API Error");
                }

                const data = await response.json();
                const reply = data.choices[0].message.content;
                
                // Display
                const displayArea = document.getElementById('response-area');
                displayArea.style.display = 'block';
                displayArea.innerHTML = `<strong>${currentStudent}:</strong><br>${reply.replace(/\n/g, '<br>')}`;
                
                document.getElementById('status').innerText = "Done! Tap to ask again.";
                speak(reply);

            } catch (error) {
                console.error(error);
                document.getElementById('status').innerText = "Error occurred.";
                alert("AI Error: " + error.message + "\n\n(Check your API Key or Internet)");
            }
        }

        // --- 4. TEXT TO SPEECH ---
        function speak(text) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-IN';
            if(currentStudent === "Mrunal") { utterance.pitch = 1.2; utterance.rate = 1.1; } 
            else { utterance.pitch = 1.0; utterance.rate = 1.0; }
            window.speechSynthesis.speak(utterance);
        }
    </script>
</body>
</html>
