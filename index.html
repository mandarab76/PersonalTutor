<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Omkar Tutor</title>
    <style>
        /* --- MOBILE-FIRST DESIGN SYSTEM --- */
        body { 
            font-family: 'Segoe UI', 'Roboto', Helvetica, Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background-color: #f4f7f6; 
            text-align: center; 
            -webkit-tap-highlight-color: transparent;
        }
        
        h1 { font-size: 22px; color: #444; margin-bottom: 25px; letter-spacing: -0.5px; }
        
        /* CARD STYLING */
        .card {
            background: white;
            border-radius: 25px;
            padding: 25px 20px;
            margin-bottom: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            transition: transform 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 4px solid transparent;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .card:active { transform: scale(0.96); }

        /* MRUNAL THEME (Playful Pink) */
        #mrunal-btn { 
            background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%); 
        }
        #mrunal-btn h2 { color: #D63384; }
        
        /* GARGI THEME (Academic Blue/Purple) */
        #gargi-btn { 
            background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); 
        }
        #gargi-btn h2 { color: #483D8B; }

        h2 { margin: 10px 0 5px 0; font-size: 26px; }
        p { margin: 0; color: rgba(0,0,0,0.6); font-weight: 600; font-size: 14px; }
        
        .icon { width: 90px; height: 90px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); margin-bottom: 10px; }

        /* ANIMATIONS */
        .listening { 
            animation: pulse 1.5s infinite; 
            border-color: #ff4757 !important; 
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.4); }
            70% { box-shadow: 0 0 0 20px rgba(255, 71, 87, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); }
        }

        /* RESPONSE AREA */
        #response-area { 
            margin-top: 25px; 
            padding: 20px; 
            background: #fff; 
            border-radius: 20px; 
            text-align: left; 
            display: none; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            font-size: 16px;
            line-height: 1.5;
            color: #333;
        }

        /* SETTINGS & INPUTS */
        #settings-area { margin-bottom: 20px; }
        #api-key-input { 
            width: 70%; padding: 12px; 
            border: 2px solid #ddd; border-radius: 12px; 
            font-size: 16px; outline: none;
        }
        .save-btn {
            padding: 12px 20px; background: #333; color: white; 
            border: none; border-radius: 12px; font-weight: bold;
        }
        #status { color: #888; margin-top: 15px; font-style: italic; font-size: 14px; }
    </style>
</head>
<body>

    <div id="settings-area">
        <input type="password" id="api-key-input" placeholder="Paste OpenAI Key (sk-...)">
        <button class="save-btn" onclick="saveKey()">Save</button>
    </div>

    <h1>Omkar School Tutor üè´</h1>

    <div class="card" id="mrunal-btn" onclick="activateAgent('Mrunal')">
        <img src="https://cdn-icons-png.flaticon.com/512/616/616430.png" class="icon" alt="Kitten">
        <h2>Mrunal</h2>
        <p>Class 4 ‚Ä¢ Enlighten & Madhup</p>
    </div>

    <div class="card" id="gargi-btn" onclick="activateAgent('Gargi')">
        <img src="https://cdn-icons-png.flaticon.com/512/867/867908.png" class="icon" alt="Wand">
        <h2>Gargi</h2>
        <p>Class 8 ‚Ä¢ NCERT & Touchpad</p>
    </div>

    <div id="status">Tap a name to start speaking... üéôÔ∏è</div>
    <div id="response-area"></div>

    <script>
        // --- 1. THE BRAIN: SYLLABUS MAPS ---
        
        // MRUNAL (Class 4) - Based on "Enlighten" & "Madhup"
        const MRUNAL_SYLLABUS = {
            "turkish": "English: The Turkish Cap (Cycle 1)",
            "cap": "English: The Turkish Cap (Cycle 1)",
            "andaman": "English: Adventure in the Andamans",
            "muttaji": "English: How old is Muttaji",
            "mars": "English: A Holiday on Mars (Half Yearly)",
            "treasure": "English: The Treasure Hunt",
            "bhabhut": "Hindi: Sikke ka Bhabhut",
            "ujiyara": "Hindi: Naya Ujiyara (Poem)",
            "phoolon": "Hindi: Phoolon Ka Nagar"
        };

        // GARGI (Class 8) - Based on uploaded PDF (Omkar School)
        const GARGI_SYLLABUS = {
            // ENGLISH (Honey Dew / It So Happened)
            "christmas": "English: The Best Christmas Present (Cycle 1)",
            "tsunami": "English: The Tsunami (Cycle 2)",
            "ant": "Poem: The Ant and the Cricket",
            "geography lesson": "Poem: Geography Lesson",
            "bepin": "English: Bepin Choudhury's Lapse of Memory",
            "jody": "English: This is Jody's Fawn",
            
            // MATH (NCERT)
            "rational": "Math: Rational Numbers (Cycle 1)",
            "linear equation": "Math: Linear Equations in One Variable",
            "quadrilateral": "Math: Understanding Quadrilaterals (Cycle 2)",
            "data": "Math: Data Handling",
            "square": "Math: Squares and Square Roots (Half Yearly)",
            "cube": "Math: Cubes and Cube Roots",
            "algebra": "Math: Algebraic Expressions",
            "mensuration": "Math: Mensuration (Formula Focus)",

            // SCIENCE (NCERT + Resource Book)
            "crop": "Science: Crop Production and Management (Cycle 1)",
            "micro": "Science: Micro Organisms: Friend and Foe",
            "coal": "Science: Coal and Petroleum",
            "force": "Science: Force and Pressure (Cycle 1)",
            "pressure": "Science: Force and Pressure",
            "friction": "Science: Friction (Cycle 2)",
            "combustion": "Science: Combustion and Flame",
            "cell": "Science: Cell Structure and Functions",
            "sound": "Science: Sound",
            "light": "Science: Light",
            "adolescence": "Science: Reaching the Age of Adolescence",

            // HISTORY/CIVICS/GEO
            "trade": "History: From Trade to Territory (Cycle 1)",
            "rebel": "History: When People Rebel 1857",
            "resource": "Geography: Resources (Cycle 1)",
            "constitution": "Civics: The Indian Constitution",
            "secularism": "Civics: Understanding Secularism",

            // COMPUTER (Touchpad Book)
            "networking": "CompSci: Computer Networking (Cycle 2)",
            "html": "CompSci: Images Links and Frames in HTML",
            "python": "CompSci: Looping in Python (Yearly)",
            "ai": "CompSci: Domains of AI"
        };

        // --- 2. CONFIGURATION ---
        let currentStudent = "";
        let apiKey = localStorage.getItem("openai_key");
        if(apiKey) document.getElementById('settings-area').style.display = 'none';

        function saveKey() {
            const input = document.getElementById('api-key-input').value;
            if(input.startsWith("sk-")) {
                localStorage.setItem("openai_key", input);
                apiKey = input;
                document.getElementById('settings-area').style.display = 'none';
                alert("Key saved! You can now use the app.");
            } else {
                alert("Invalid Key. It must start with 'sk-'");
            }
        }

        // --- 3. VOICE ENGINE ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.lang = 'en-IN'; // Optimized for Indian Accents
        recognition.continuous = false;

        recognition.onstart = () => {
            document.getElementById('status').innerText = "Listening... Speak now! üéôÔ∏è";
            document.getElementById(currentStudent.toLowerCase() + '-btn').classList.add('listening');
        };

        recognition.onend = () => {
            document.getElementById('status').innerText = "Processing thought... üß†";
            document.querySelectorAll('.card').forEach(c => c.classList.remove('listening'));
        };

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            document.getElementById('status').innerText = `Heard: "${transcript}"`;
            processQuery(transcript);
        };

        recognition.onerror = (event) => {
            document.getElementById('status').innerText = "Error: " + event.error;
            alert("Microphone Error: " + event.error + ". Ensure you are on HTTPS.");
        };

        function activateAgent(student) {
            if(!apiKey) { alert("Please enter API Key first!"); return; }
            currentStudent = student;
            // Short delay to allow TTS to finish saying hello before listening
            speak(`Hi ${student}. I am ready.`, () => {
                recognition.start();
            });
        }

        // --- 4. AI BRAIN (GPT-4o) ---
        async function processQuery(text) {
            let systemPrompt = "";
            let context = "General Knowledge";
            let activeSyllabus = (currentStudent === "Mrunal") ? MRUNAL_SYLLABUS : GARGI_SYLLABUS;

            // 1. Check Syllabus Map
            for (let key in activeSyllabus) {
                if (text.toLowerCase().includes(key)) {
                    context = "Syllabus Match: " + activeSyllabus[key];
                    break;
                }
            }

            // 2. Build Persona
            if (currentStudent === "Mrunal") {
                systemPrompt = `
                You are a magical, playful tutor for Mrunal (Class 4).
                Input: "${text}"
                Context: ${context}
                
                Rules:
                1. Tone: Super enthusiastic, simple English, use emojis (ü¶Ñ, ‚ú®).
                2. Content: Explain the concept in max 2 sentences. 
                3. If it's a story (e.g., Turkish Cap), summarize the moral in 1 line.
                4. End with: "Shall I find a cartoon video for this?"
                `;
            } else {
                systemPrompt = `
                You are a professional exam strategist for Gargi (Class 8).
                Input: "${text}"
                Context: ${context}
                
                Rules:
                1. Tone: Direct, academic, no fluff.
                2. Content: Provide the Definition (Scientific/Mathematical) and Key Formula if applicable.
                3. Structure: Use bullet points.
                4. Highlight: Mention if this is a "Cycle Test" topic based on context.
                `;
            }

            // 3. Call API
            try {
                const response = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "gpt-4o",
                        messages: [{role: "system", content: systemPrompt}, {role: "user", content: text}],
                        max_tokens: 150
                    })
                });
                
                const data = await response.json();
                if(data.error) throw new Error(data.error.message);
                
                const reply = data.choices[0].message.content;
                
                // Display
                const displayArea = document.getElementById('response-area');
                displayArea.style.display = 'block';
                // Convert newlines to HTML breaks and Bold to strong tags
                let formattedReply = reply.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                displayArea.innerHTML = `<strong>${currentStudent}:</strong><br>${formattedReply}`;
                
                // Speak
                speak(reply);
                document.getElementById('status').innerText = "Tap card to speak again";

            } catch (error) {
                alert("AI Error: " + error.message);
                document.getElementById('status').innerText = "Error. Try again.";
            }
        }

        // --- 5. TEXT TO SPEECH ---
        function speak(text, callback) {
            window.speechSynthesis.cancel();
            // Strip markdown/emojis for speech clarity
            const cleanText = text.replace(/[*#]/g, '');
            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.lang = 'en-IN'; // Indian English
            
            if(currentStudent === "Mrunal") { 
                utterance.pitch = 1.2; // Higher pitch for friendly/kid tone
                utterance.rate = 1.0; 
            } else { 
                utterance.pitch = 1.0; // Normal pitch for serious tone
                utterance.rate = 1.1; // Slightly faster
            }

            utterance.onend = () => {
                if (callback) callback();
            };

            window.speechSynthesis.speak(utterance);
        }
    </script>
</body>
</html>
